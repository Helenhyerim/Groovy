<?xml version="1.0" encoding="UTF-8"?>

<!-- ==== #29. mapper 기본설정 ==== -->
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- ==== #29. 루트 엘리먼트 & 네임스페이스 설정(프로젝트 전체내에서 유일해야 한다.) ==== -->
<mapper namespace="leejh">

	<!-- === 로그인 처리하기 === -->
	
	<select id="getLoginEmployee" resultType="com.spring.groovy.model.EmployeeVO" parameterType="HashMap">

		SELECT  pk_empnum, pwd, name,  address,  detailaddress,
			 extraaddress, postcode, phone,  email,  birthday, gender,
			 registerday, startday, resignationstatus,  nvl(resignationday,'2099-12-31'),  fk_vstatus,
			  fk_deptnum,  fk_spotnum,  emppicturename,  salary,  lastpwdchangedate
		from tbl_employee
		where pk_empnum = #{pk_empnum} and pwd= #{pwd}
	</select>
	
	<!-- << 로그인 기록 카운트 >> -->
	
	<!-- === 해당하는 이메일과 사원번호에 존재하는 사원 정보 찾기(select) === -->
	<select id="sendCodeEmail" parameterType="HashMap" resultType="String">
		select pk_empnum
		from tbl_employee
		where pk_empnum = #{pk_empnum} and  email = #{email} 
	</select>
	
	<!-- === 새비밀번호 업데이트 메서드(update) === -->
	<update id="newPwdUpdate" parameterType="HashMap">
		update tbl_employee set pwd = #{newPassword}
		where pk_empnum = #{pk_empnum} and  email = #{email} 
	</update>


	<!-- === 부서명 가져오기  === -->
	<select id="getDepts" resultType="com.spring.groovy.model.DepartmentVO">
		select PK_DEPTNUM, DEPTNAMEKOR
		from TBL_DEPARTMENT
		order by pk_deptnum
	</select>
	
	<!-- === 직위명을 가져오기 위함  === -->
	<select id="getSpots" resultType="com.spring.groovy.model.SpotVO">
		select PK_SPOTNUM, SPOTNAMEKOR
		from TBL_SPOT
		order by PK_SPOTNUM
	</select>
	
	<select id="getEmpList" resultType="com.spring.groovy.model.EmployeeVO">
				select  pk_empnum, name, address, detailaddress, postcode, 
				        phone, email, birthday, gender, registerday, 
				        startday, resignationstatus,  
				        resignationday,  fk_vstatus,     
				        emppicturename,  salary, lastpwdchangedate, emppicturefilename,
				        spotnamekor, deptnamekor, pk_spotnum
				from
				(
					SELECT  E.pk_empnum, E.name, E.address, E.detailaddress, E.postcode, 
					        E.phone, E.email, E.birthday, E.gender, E.registerday, 
					        to_char(E.startday, 'yyyy-mm-dd') as startday, E.resignationstatus,  
					        E.resignationday,  E.fk_vstatus,     
					        E.emppicturename,  E.salary, E.lastpwdchangedate, E.emppicturefilename,
					        s.spotnamekor, s.pk_spotnum,
					        d.deptnamekor, d.pk_deptnum
					from tbl_employee E
					JOIN TBL_SPOT S 
					ON E.fk_spotnum = S.pk_spotnum
					JOIN TBL_DEPARTMENT D 
					ON E.fk_deptnum = D.pk_deptnum
				) V
				where 1=1
					and name = #{searchEmp}
		        	<!-- and pk_deptnum = #{pk_deptnum} -->
		        order by pk_deptnum , pk_spotnum desc;
	
	</select>
	
</mapper>